# Configuration for DIY MMU2S based on SKR-MINI
# Jeremy Briffaut kakou@kakou.org
# More info : https://www.thingiverse.com/thing:3910546
#
#
# config inspired from https://github.com/mwr666/klipper/blob/sunbeam2.0c_multi_mcu_mmu2/config/printer-protodev-corexy-multi-mcu-mmu2.cfg

[include printer-mmu2s-board.cfg]
[include printer-mmu2s-config.cfg]

###############################
###############################

[gcode_macro ACTIVATE_EXTRUDER]
rename_existing: OACTIVATE_EXTRUDER
default_parameter_EXTRUDER: extruder
gcode:
     M118 Set extruder : {EXTRUDER}

###############################
###############################

[gcode_macro DISPLAY_ERROR]
gcode:
   M118 Error status : 
   M118 Retry load     : {printer["gcode_macro MMU_ERROR_INCREMENT_LOAD"].error_retry_load}
   M118 Retry unload   : {printer["gcode_macro MMU_ERROR_INCREMENT_UNLOAD"].error_retry_unload}
   {% if printer["gcode_macro VAR_MMU2S"].splitter_endstop == 1 %}   
   M118 Retry splitter : {printer["gcode_macro MMU_ERROR_INCREMENT_SPLITTER"].error_retry_splitter}
   {% endif %}
   M118 Intervention   : {printer["gcode_macro MMU_ERROR_INCREMENT_PAUSE"].error_retry_pause}

[gcode_macro MMU_ERROR_INCREMENT_LOAD]
variable_error_retry_load: 0
gcode:
   {% set error = error_retry_load + 1 %}
   SET_GCODE_VARIABLE MACRO=MMU_ERROR_INCREMENT_LOAD VARIABLE=error_retry_load VALUE={error}

[gcode_macro MMU_ERROR_INCREMENT_UNLOAD]
variable_error_retry_unload: 0
gcode:
   {% set error = error_retry_unload + 1 %}
   SET_GCODE_VARIABLE MACRO=MMU_ERROR_INCREMENT_UNLOAD VARIABLE=error_retry_unload VALUE={error}

[gcode_macro MMU_ERROR_INCREMENT_PAUSE]
variable_error_retry_pause: 0
gcode:
   {% set error = error_retry_pause + 1 %}
   SET_GCODE_VARIABLE MACRO=MMU_ERROR_INCREMENT_PAUSE VARIABLE=error_retry_pause VALUE={error}

[gcode_macro MMU_ERROR_INCREMENT_SPLITTER]
variable_error_retry_splitter: 0
gcode:
   {% set error = error_retry_splitter + 1 %}
   SET_GCODE_VARIABLE MACRO=MMU_ERROR_INCREMENT_SPLITTER VARIABLE=error_retry_splitter VALUE={error}

###############################
#
# Purge MACROS
#
###############################

# Display current purge length
[gcode_macro PURGE_STATUS]
gcode:
    M118 Purge status (unload/load) :
    M118 Filament 0    : {printer["gcode_macro VAR_MMU2S"].t0_purge_unload_length}mm / {printer["gcode_macro VAR_MMU2S"].t0_purge_load_length}mm
    M118 Filament 1    : {printer["gcode_macro VAR_MMU2S"].t1_purge_unload_length}mm / {printer["gcode_macro VAR_MMU2S"].t1_purge_load_length}mm
    M118 Filament 2    : {printer["gcode_macro VAR_MMU2S"].t2_purge_unload_length}mm / {printer["gcode_macro VAR_MMU2S"].t2_purge_load_length}mm
    M118 Filament 3    : {printer["gcode_macro VAR_MMU2S"].t3_purge_unload_length}mm / {printer["gcode_macro VAR_MMU2S"].t3_purge_load_length}mm
    M118 Filament 4    : {printer["gcode_macro VAR_MMU2S"].t4_purge_unload_length}mm / {printer["gcode_macro VAR_MMU2S"].t4_purge_load_length}mm

[gcode_macro SET_PURGE_LENGTH]
default_parameter_FILAMENT: 0
default_parameter_UNLOAD: 0
default_parameter_LOAD: 40
gcode:
    M118 Set filament {FILAMENT} purge length {UNLOAD}/{LOAD}
    {%if FILAMENT|int == 0 %}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t0_purge_load_length VALUE={LOAD}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t0_purge_unload_length VALUE={UNLOAD}
    {% endif %}
    {%if FILAMENT|int == 1 %}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t1_purge_load_length VALUE={LOAD}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t1_purge_unload_length VALUE={UNLOAD}
    {% endif %}
    {%if FILAMENT|int == 2 %}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t2_purge_load_length VALUE={LOAD}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t2_purge_unload_length VALUE={UNLOAD}
    {% endif %}
    {%if FILAMENT|int == 3 %}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t3_purge_load_length VALUE={LOAD}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t3_purge_unload_length VALUE={UNLOAD}
    {% endif %}
    {%if FILAMENT|int == 4 %}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t4_purge_load_length VALUE={LOAD}
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=t4_purge_unload_length VALUE={UNLOAD}
    {% endif %}
    PURGE_STATUS

[gcode_macro SET_PURGE_SPEED]
default_parameter_SPEED: 374
gcode:
    M118 Set purge speed at {SPEED} mm/min
    SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=purge_speed VALUE={SPEED}

###############################
#
# MMU2S endstop status : IR extruder, PINDA, selector switch
# 0 : open, 1 : TRIGGERED
#
###############################

# Display the last queried status
[gcode_macro ENDSTOPS_STATUS]
gcode:
    M118 Enstop status :
    M118 Extruder : {printer["filament_switch_sensor ir_sensor"].filament_detected}
    {% if printer["gcode_macro VAR_MMU2S"].splitter_endstop == 1 %}
    M118 Splitter : {printer["filament_switch_sensor splitter_sensor"].filament_detected}
    {% endif %}
    M118 PINDA    : {printer.query_endstops.last_query["manual_stepper gear_stepper"]}
    M118 Selector : {printer.query_endstops.last_query["manual_stepper selector_stepper"]}

# Query and display the status
[gcode_macro infos]
gcode:
    QUERY_ENDSTOPS
    ENDSTOPS_STATUS


#SET_GCODE_VARIABLE MACRO=VAR_MMU2S VARIABLE=splitter_endstop VALUE=0

###############################
#
# PAUSE MACROS
# PAUSE_MMU is called when an human intervention is needed
# use MMU_UNLOCK to park the idler and start the manual intervention
# and use RESUME when the invention is ended to resume the current print
#
###############################

[pause_resume]
#recover_velocity: 50.

# park the idler, stop the delayed stop of the heater
[gcode_macro MMU_UNLOCK]
gcode:
   M118 Resume print
   SET_GCODE_VARIABLE MACRO=PAUSE_MMU VARIABLE=is_paused VALUE=0
   UPDATE_DELAYED_GCODE ID=disable_heater DURATION=0
   HOME_IDLER
   M109 S{printer["gcode_macro PAUSE_MMU"].extruder_temp}

[delayed_gcode disable_heater]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int != 0 %}
    M118 Disable extruder heater
    M104 S0
    {% endif %}

[gcode_macro GO_TO_PARKING]
gcode:
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x} Y{printer["gcode_macro VAR_MMU2S"].pause_y} F3000

[gcode_macro GO_TO_PARKING_OUT]
gcode:
    G91
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x_out} Y{printer["gcode_macro VAR_MMU2S"].pause_y_out} F3000
    G90

# Pause the MMU, park the extruder at the parking position
# Save the current state and start the delayed stop of the heated
# modify the timeout of the printer acorrdly to timeout_pause
[gcode_macro PAUSE_MMU]
variable_is_paused: 0
variable_extruder_temp: 0
gcode:
    SET_GCODE_VARIABLE MACRO=PAUSE_MMU VARIABLE=extruder_temp VALUE={printer.extruder.temperature}
    SET_GCODE_VARIABLE MACRO=PAUSE_MMU VARIABLE=is_paused VALUE=1
    SAVE_GCODE_STATE NAME=PAUSE_MMU_state
    SET_IDLE_TIMEOUT TIMEOUT={printer["gcode_macro VAR_MMU2S"].timeout_pause}
    UPDATE_DELAYED_GCODE ID=disable_heater DURATION={printer["gcode_macro VAR_MMU2S"].disable_heater}
    M118 START PAUSE
    MMU_ERROR_INCREMENT_PAUSE
    bip
    bip
    bip
    PAUSE
    G4 P2000
    M400
    G91
    G1 Z{printer["gcode_macro VAR_MMU2S"].pause_z}
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x} Y{printer["gcode_macro VAR_MMU2S"].pause_y} F3000
    bip
    bip
    bip
    M118 END PAUSE
    RESTORE_GCODE_STATE NAME=PAUSE_MMU_state MOVE=1

# call this macro to correctly RESUME with MMU check
[gcode_macro RESUME_MMU]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
        M118 Resume print ...
        RESUME
    {% else %}
        M118 Filament not in extruder, could not resume
    {% endif %}
    {% else %}
        M118 Unlock MMU before resuming !
    {% endif %}

############################################
#
# T0, T1, ..., T4 : Change extruder MACRO
# if th new extruder is different from the current extruder :
#     eject the filament if needed
#     load the new one
#
############################################

[gcode_macro T0]
gcode:
    M117 Change Tool T0
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != 0 %}
    UT
    LT VALUE=0
    {% else %}
    M117 No change needed
    {% endif %}

[gcode_macro T1]
gcode:
    M117 Change Tool T1
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != 1 %}
    UT
    LT VALUE=1
    {% else %}
    M117 No change needed
    {% endif %}

[gcode_macro T2]
gcode:
    M117 Change Tool T2
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != 2 %}
    UT
    LT VALUE=2
    {% else %}
    M117 No change needed
    {% endif %}

[gcode_macro T3]
gcode:
    M117 Change Tool T3
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != 3 %}
    UT
    LT VALUE=3
    {% else %}
    M117 No change needed
    {% endif %}

[gcode_macro T4]
gcode:
    M117 Change Tool T4
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != 4 %}
    UT
    LT VALUE=4
    {% else %}
    M117 No change needed
    {% endif %}

############################################
#
# Unloading/Loading Macros
#
############################################

# Load filament from MMU2S to nozzle
[gcode_macro LT]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
        M118 LT {params.VALUE|int} ...
        SELECT_TOOL VALUE={params.VALUE|int}
        LOAD_FILAMENT_TO_EXTRUDER
        LOAD_FILAMENT_IN_EXTRUDER
        {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
            {% if params.VALUE|int == 1 %}
                 M400
                 RESET_FILAMENT_LENGTH_SENSOR
	         ENABLE_FILAMENT_LENGTH_SENSOR
            {% endif %}
        {% endif %}
    {% endif %}

# Unload filament from nozzle to MMU2S
[gcode_macro UT]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != -1 %}
    M118 UT {printer["gcode_macro SELECT_TOOL"].color_selected|int} ...
    {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
         DISABLE_FILAMENT_LENGTH_SENSOR
    {% endif %}
    SELECT_TOOL VALUE={printer["gcode_macro SELECT_TOOL"].color_selected|int}
    UNLOAD_FILAMENT_IN_EXTRUDER
    UNLOAD_FILAMENT_FROM_EXTRUDER
    {% endif %}
    {% endif %}

############################################
#
# Select/Unselect a tool
# move the idler and the color selector (if needed) to the requested tool (0-4)
#
############################################

# Select a tool. move the idler and then move the color selector (if needed)
[gcode_macro SELECT_TOOL]
variable_tool_selected: -1
variable_color_selected: -1
variable_old_color_selected: -1
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro HOME_MMU"].home != -1 %}
        M118 Select Tool {params.VALUE} ...
        MANUAL_STEPPER STEPPER=idler_stepper MOVE={printer["gcode_macro VAR_MMU2S"].idler[params.VALUE|int]}
        {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
        MANUAL_STEPPER STEPPER=selector_stepper MOVE={printer["gcode_macro VAR_MMU2S"].colorselector[params.VALUE|int]}
        {% endif %}
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=tool_selected VALUE={params.VALUE}
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=old_color_selected VALUE={color_selected}
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE={params.VALUE}
        M118 Tool {params.VALUE} Enabled
    {% else %}
    M118 Could not select tool, MMU is not homed
    {% endif %}
    {% endif %}

# Unselect a tool, only park the idler
[gcode_macro UNSELECT_TOOL]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro HOME_MMU"].home != -1 %}
        MANUAL_STEPPER STEPPER=idler_stepper MOVE={printer["gcode_macro VAR_MMU2S"].idler_home_position}
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=tool_selected VALUE=-1
    {% else %}
        M118 Could not unselect tool, MMU is not homed
    {% endif %}
    {% endif %}

############################################
#
# Purge macros
#
#
############################################
[gcode_macro DEPLOY_PURGE]
variable_z_lifted: -1
variable_x_move: 40
variable_y_move: 0
variable_z_lift: 0
gcode:
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x + printer["gcode_macro DEPLOY_PURGE"].x_move} Y{printer["gcode_macro VAR_MMU2S"].pause_y + printer["gcode_macro DEPLOY_PURGE"].y_move} F9000
    {% if printer.toolhead.position.z|int < printer["gcode_macro DEPLOY_PURGE"].z_lift  %}
    SET_GCODE_VARIABLE  MACRO=DEPLOY_PURGE VARIABLE=z_lifted VALUE=1
    G91
    G1 Z+{printer["gcode_macro DEPLOY_PURGE"].z_lift} F1200
    G90
    {% endif %}
    G4 P1000
    SET_SERVO SERVO=purge_servo angle=170
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x} Y{printer["gcode_macro VAR_MMU2S"].pause_y} F9000

[gcode_macro RETRACT_PURGE]
gcode:
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x + printer["gcode_macro DEPLOY_PURGE"].x_move} Y{printer["gcode_macro VAR_MMU2S"].pause_y + printer["gcode_macro DEPLOY_PURGE"].y_move} F9000
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x} Y{printer["gcode_macro VAR_MMU2S"].pause_y} F9000
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x + printer["gcode_macro DEPLOY_PURGE"].x_move} Y{printer["gcode_macro VAR_MMU2S"].pause_y + printer["gcode_macro DEPLOY_PURGE"].y_move} F9000
    SET_SERVO SERVO=purge_servo angle=0
    SET_SERVO SERVO=purge_servo angle=170
    SET_SERVO SERVO=purge_servo angle=0
    {% if printer["gcode_macro DEPLOY_PURGE"].z_lifted|int == 1 %}
    G91
    G1 Z-{printer["gcode_macro DEPLOY_PURGE"].z_lift} F1200
    G90
    {% endif %}
    SET_GCODE_VARIABLE  MACRO=DEPLOY_PURGE VARIABLE=z_lifted VALUE=-1

[gcode_macro MOVE_PURGE_FILAMENT]
default_parameter_PURGE_LENGTH: 60
default_parameter_PURGE_MAX: 60
gcode:
    {% if printer["gcode_macro VAR_MMU2S"].enable_purge_servo == 1 %}
    M118 Purging : {PURGE_LENGTH|int} mm
    G91
    G92 E0
    {% for i in range(PURGE_LENGTH|int//PURGE_MAX|int) %}
        G1 E{PURGE_MAX} F{printer["gcode_macro VAR_MMU2S"].purge_speed}
        M400
        G4 P2000
        G92 E0
    {% endfor %}
    G1 E{PURGE_LENGTH|int%PURGE_MAX|int} F{printer["gcode_macro VAR_MMU2S"].purge_speed}
    M400
    G4 P2000
    G92 E0
    G90
    {% else %}
        M118 Could not purge with servo, not enabled ...
    {% endif %}

[gcode_macro CHECK_JAMMING]
gcode:
    {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
        M118 capteur  : {printer["filament_length_sensor l1"].length|float}
        M118 extruder : {printer["filament_length_sensor l1"].extruder_position|float}
    {% endif %}

[gcode_macro PURGE_FILAMENT]
variable_purge_length: 0
gcode:
    {% if printer["gcode_macro VAR_MMU2S"].purge_after_load == 1 %}
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Purging Filament...
        G91
        G92 E0
        G1 E2.0000 F1140
        G1 E7.0000 F1680
        G1 E1.0000 F168
        {% if printer["gcode_macro SELECT_TOOL"].old_color_selected|int == 0 %}
	{% set purge_length = printer["gcode_macro VAR_MMU2S"].t0_purge_unload_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].old_color_selected|int == 1 %}
	{% set purge_length = printer["gcode_macro VAR_MMU2S"].t1_purge_unload_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].old_color_selected|int == 2 %}
	{% set purge_length = printer["gcode_macro VAR_MMU2S"].t2_purge_unload_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].old_color_selected|int == 3 %}
	{% set purge_length = printer["gcode_macro VAR_MMU2S"].t3_purge_unload_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].old_color_selected|int == 4 %}
	{% set purge_length = printer["gcode_macro VAR_MMU2S"].t4_purge_unload_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].color_selected|int == 0 %}
	{% set purge_length = purge_length + printer["gcode_macro VAR_MMU2S"].t0_purge_load_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].color_selected|int == 1 %}
	{% set purge_length = purge_length + printer["gcode_macro VAR_MMU2S"].t1_purge_load_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].color_selected|int == 2 %}
	{% set purge_length = purge_length + printer["gcode_macro VAR_MMU2S"].t2_purge_load_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].color_selected|int == 3 %}
	{% set purge_length = purge_length + printer["gcode_macro VAR_MMU2S"].t3_purge_load_length %}
        {% endif %}
        {% if printer["gcode_macro SELECT_TOOL"].color_selected|int == 4 %}
	{% set purge_length = purge_length + printer["gcode_macro VAR_MMU2S"].t4_purge_load_length %}
        {% endif %}
        G92 E0
        {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
            RESET_FILAMENT_LENGTH_SENSOR
        {% endif %}
        {% if printer["gcode_macro VAR_MMU2S"].enable_purge_servo == 1 %}
            MOVE_PURGE_FILAMENT PURGE_LENGTH={purge_length}
        {% else %}
            G1 E{purge_length} F{printer["gcode_macro VAR_MMU2S"].purge_speed}
        {% endif %}
        {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
            M400
            CHECK_JAMMING
        {% endif %}
        {% if printer["gcode_macro VAR_MMU2S"].enable_length_sensor == 1 %}
            RESET_FILAMENT_LENGTH_SENSOR
        {% endif %}
        G92 E0
        G90
    {% endif %}
    {% endif %}
    {% endif %}


############################################
#
# Loading/Unloading part FROM/TO EXTRUDER TO/FROM NOZZLE
# During loading, if the IR sensor does not detect the filament, it tries 3 times to reinsert it
#
############################################

# VERIFY if filament is correctly loaded
[gcode_macro CHECK_LOAD_FILAMENT_IN_EXTRUDER]
variable_filament_in: 0
gcode:
    {% if printer["gcode_macro CHECK_LOAD_FILAMENT_IN_EXTRUDER"].filament_in|int == 0 %}
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
    M118 Check if filament is loaded
    G91
    G92 E0
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=10 SPEED=10 SET_POSITION=0 SYNC=0
    G1 E10 F600
    MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
    MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].load_in_extruder - 10} SPEED=10 SET_POSITION=0 SYNC=0
    G1 E-{printer["gcode_macro VAR_MMU2S"].load_in_extruder - 10} F600
    MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
    MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
    G92 E0
    G90
    G4 P1000
    {% endif %}
    RETRY_LOAD_FILAMENT_IN_EXTRUDER
    {% endif %}

# Try to reinsert the filament into the extruder
# Called when the IR sensor does not detect the filament
# the MMU2S push the filament of 10mm
# and the extruder gear try to insert it into the nozzle
[gcode_macro RETRY_LOAD_FILAMENT_IN_EXTRUDER]
gcode:
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == False %}
    M118 Retry loading ....
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Loading Filament...
        MMU_ERROR_INCREMENT_LOAD
        G90
        GO_TO_PARKING
        G91
        G92 E0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].load_in_extruder} SPEED=10 SET_POSITION=0 SYNC=0
        G1 E{printer["gcode_macro VAR_MMU2S"].load_in_extruder} F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
        G90
    {% endif %}
    {% endif %}
    G4 P1000
    {% else %}
        M118 Filament in extruder : OK
        G91
        G92 E0
    	SET_GCODE_VARIABLE MACRO=CHECK_LOAD_FILAMENT_IN_EXTRUDER VARIABLE=filament_in VALUE=1
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].load_in_extruder} SPEED=10 SET_POSITION=0 SYNC=0
        G1 E{printer["gcode_macro VAR_MMU2S"].load_in_extruder - 10} F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
	G90   
    {% endif %}

# Load the filament into the extruder
# the MMU2S push the filament of 20mm
# and the extruder gear try to insert it into the nozzle
# if the filament is not detected by the IR, call RETRY_LOAD_FILAMENT_IN_EXTRUDER 3 times
#
# Call PAUSE_MMU if the filament is not detected by the IR sensor
[gcode_macro LOAD_FILAMENT_IN_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Loading Filament...
        SET_GCODE_VARIABLE MACRO=CHECK_LOAD_FILAMENT_IN_EXTRUDER VARIABLE=filament_in VALUE=0
        G91
        G92 E0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].load_in_extruder} SPEED=10 SET_POSITION=0 SYNC=0
        G1 E{printer["gcode_macro VAR_MMU2S"].load_in_extruder} F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
        G90
        G4 P1000
        CHECK_LOAD_FILAMENT_IN_EXTRUDER
        CHECK_LOAD_FILAMENT_IN_EXTRUDER
        CHECK_LOAD_FILAMENT_IN_EXTRUDER
        IS_FILAMENT_IN_EXTRUDER
        UNSELECT_TOOL
        PURGE_FILAMENT
        M118 Load Complete
    {% else %}
    M118 Extruder too cold
    PAUSE_MMU
    {% endif %}
    {% endif %}

# Retry unload, try correct misalignement of bondtech gear
[gcode_macro RETRY_UNLOAD_FILAMENT_IN_EXTRUDER]
gcode:
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
    M118 Retry unloading extruder....
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Unloading Filament extruder ...
        MMU_ERROR_INCREMENT_UNLOAD
        G91
        G92 E0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=10 SPEED=10 SET_POSITION=0 SYNC=0
        G1 E10 F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder1} SPEED=10 SET_POSITION=0 SYNC=0
        G1 E-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder1} F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder2} SPEED=50 SET_POSITION=0 SYNC=0
        G1 E-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder2} F3000
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
        G90
    {% endif %}
    {% endif %}
    {% endif %}

# Unload the filament from the nozzle (without RAMMING !!!)
# Retract the filament from the nozzle to the out of the extruder gear
#
# Call PAUSE_MMU if the IR sensor detects the filament after the ejection
[gcode_macro UNLOAD_FILAMENT_IN_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Unloading Filament...
        G91
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder1} SPEED=10 SET_POSITION=0 SYNC=0
        G1 E-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder1} F600
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder2} SPEED=50 SET_POSITION=0 SYNC=0
        G1 E-{printer["gcode_macro VAR_MMU2S"].unload_in_extruder2} F3000
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G90
        G92 E0
        G4 P1000
        RETRY_UNLOAD_FILAMENT_IN_EXTRUDER
        RETRY_UNLOAD_FILAMENT_IN_EXTRUDER
        RETRY_UNLOAD_FILAMENT_IN_EXTRUDER
        IS_FILAMENT_STUCK_IN_EXTRUDER
        M118 Filament removed
    {% else %}
        M118 Extruder too cold
        PAUSE_MMU
    {% endif %}
    {% endif %}

# Ramming process for standart PLA, code extracted from slic3r gcode
[gcode_macro RAMMING_SLICER]
gcode:
    G91
    G92 E0
    G1 E0.6873 F165
    G1 E0.7007 F168
    G1 E0.7376 F177
    G1 E0.7879 F189
    G1 E0.8214 F197
    G1 E0.8483 F204
    G1 E0.9019 F216
    G1 E0.9757 F234
    G1 E1.0260 F246
    G1 E1.0427 F250
    G1 E-15.000 F6000.0
    G1 E-24.5000 F5400.0
    G1 E-7.0000 F2700.0
    G1 E-3.5000 F1620.0
    G1 E20.000 F180.0
    G1 E-20.000 F160.0
    G1 E20.000 F140.0
    G1 E-20.000 F120.0
    G1 E-50.0000 F2000
    G92 E0

# Unload from extruder with ramming
[gcode_macro UNLOAD_FILAMENT_IN_EXTRUDER_WITH_RAMMING]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int == -1 %}
        M118 Ramming and Unloading Filament...
        G91
        RAMMING_SLICER
        UNLOAD_FILAMENT_IN_EXTRUDER
        M118 Filament rammed and removed
    {% else %}
        M118 Tool selected, UNSELECT it
        PAUSE_MMU
    {% endif %}
    {% else %}
        M118 Extruder too cold
        PAUSE_MMU
    {% endif %}
    {% endif %}

############################################
#
# Loading/Unloading MACROS from MMU2S to the enter of the extruder gear
#
############################################

# Load filament until the PINDA detect it and push it 10mm more to be sure is well detected
#
# PAUSE_MMU is called if the PINDA does not detect the filament
[gcode_macro LOAD_FILAMENT_TO_PINDA]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Loading filament to PINDA ...
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].pinda_load_length} STOP_ON_ENDSTOP=2
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=10
        IS_FILAMENT_IN_PINDA
        M118 Loading done to PINDA
    {% else %}
        M118 Cannot load to PINDA, tool not selected !!
    {% endif %}
    {% endif %}

# Load from the PINDA to the extruder gear
[gcode_macro LOAD_FILAMENT_FROM_PINDA_TO_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Loading filament from PINDA to extruder ...
        G91
        G92 E0
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].bowden_load_length1} SPEED=120
        MANUAL_STEPPER STEPPER=gear_stepper MOVE={printer["gcode_macro VAR_MMU2S"].bowden_load_length2} SPEED=20 SET_POSITION=0 SYNC=0
        G1 E{printer["gcode_macro VAR_MMU2S"].bowden_load_length2} F1200
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
        M118 Loading done from PINDA to extruder
    {% else %}
        M118 Cannot load to extruder, tool not selected !!
    {% endif %}
    {% endif %}

# Load from MMU2S to extruder gear by calling LOAD_FILAMENT_TO_PINDA and next LOAD_FILAMENT_FROM_PINDA_TO_EXTRUDER
#
# PAUSE_MMU is called if the PINDA does not detect the filament
[gcode_macro LOAD_FILAMENT_TO_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Loading filament from MMU to extruder ...
        {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
        LOAD_FILAMENT_TO_PINDA
        {% endif %}
        LOAD_FILAMENT_FROM_PINDA_TO_EXTRUDER
        M118 Loading done from MMU to extruder
    {% else %}
        M118 Cannot load to extruder, tool not selected !!
    {% endif %}
    {% endif %}

# Unload filament until the PINDA detect it and push it -10mm more to be sure is well not detected
#
# PAUSE_MMU is called if the PINDA does detect the filament
[gcode_macro UNLOAD_FILAMENT_FROM_PINDA]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Unloading filament from PINDA ...
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].pinda_unload_length}
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-10
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        IS_FILAMENT_STUCK_IN_PINDA
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE=-1
        M118 Unloading done from PINDA
    {% else %}
        M118 Cannot unload from PINDA, tool not selected !!
    {% endif %}
    {% endif %}


# Retry unload from splitter
[gcode_macro RETRY_UNLOAD_FILAMENT_IN_SPLITTER]
gcode:
    {% if printer["filament_switch_sensor splitter_sensor"].filament_detected == True %}
    M118 Retry unloading splitter ....
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer.extruder.temperature > printer["gcode_macro VAR_MMU2S"].min_temp_extruder %}
        M118 Unloading Filament splitter  ...
        MMU_ERROR_INCREMENT_SPLITTER
        G91
        G92 E0
        G1 E20 F500
        G1 E-20 F200
	SELECT_TOOL VALUE={printer["gcode_macro SELECT_TOOL"].color_selected|int}
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-30 SPEED=50 SET_POSITION=0 SYNC=0
        G1 E-30 F3000
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        UNSELECT_TOOL
        G92 E0
        G90
    {% endif %}
    {% endif %}
    G4 P1000
    {% endif %}

# Unload from extruder gear to the PINDA
[gcode_macro UNLOAD_FILAMENT_FROM_EXTRUDER_TO_PINDA]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Unloading filament from extruder to PINDA ...
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].bowden_unload_length} SPEED=120 STOP_ON_ENDSTOP=-2
        IS_FILAMENT_STUCK_IN_PINDA
        {% else %}
        G91
        G92 E0
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=-{printer["gcode_macro VAR_MMU2S"].bowden_unload_length} SPEED=20 SET_POSITION=0 SYNC=0
        G1 E-{printer["gcode_macro VAR_MMU2S"].bowden_unload_length} F1200
        MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G92 E0
        {% endif %}
        {% if printer["gcode_macro VAR_MMU2S"].splitter_endstop == 1 %}
        G4 P1000
        RETRY_UNLOAD_FILAMENT_IN_SPLITTER
        RETRY_UNLOAD_FILAMENT_IN_SPLITTER
        RETRY_UNLOAD_FILAMENT_IN_SPLITTER
        UNSELECT_TOOL
        IS_FILAMENT_STUCK_IN_SPLITTER
        {% endif %}
        M118 Unloading done from PINDA to extruder
    {% else %}
        M118 Cannot unload from extruder to PINDA, tool not selected !!
    {% endif %}
    {% endif %}

# Unload from the extruder gear to the MMU2S by calling UNLOAD_FILAMENT_FROM_EXTRUDER_TO_PINDA and next UNLOAD_FILAMENT_FROM_PINDA
[gcode_macro UNLOAD_FILAMENT_FROM_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].tool_selected|int != -1 %}
        M118 Unloading filament from extruder to MMU ...
        UNLOAD_FILAMENT_FROM_EXTRUDER_TO_PINDA
        {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
        UNLOAD_FILAMENT_FROM_PINDA
        {% else %}
        SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE=-1
        {% endif %}
        M118 Unloading done from extruder to MMU
    {% else %}
        M118 Cannot unload from extruder to MMU, tool not selected !!
    {% endif %}
    {% endif %}

############################################
#
# Endstop check MACROS
# Verify the state of the PINDA or the IR sensor
#
############################################

# Call PAUSE_MMU if the filament is not detected by the IR sensor
[gcode_macro IS_FILAMENT_IN_EXTRUDER]
gcode:
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
        M118 Filament in extruder
    {% else %}
        M118 Filament not in extruder
        PAUSE_MMU
    {% endif %}

# Call PAUSE_MMU if the filament is not detected by the PINDA
[gcode_macro IS_FILAMENT_IN_PINDA]
gcode:
    QUERY_ENDSTOPS
    IS_IN_PINDA

[gcode_macro IS_IN_PINDA]
gcode:
    {% if printer.query_endstops.last_query["manual_stepper gear_stepper"] == 1 %}
        M118 Filament in PINDA
    {% else %}
        M118 Filament not in PINDA
        PAUSE_MMU
    {% endif %}


# Call PAUSE_MMU if the filament is detected by the IR sensor
[gcode_macro IS_FILAMENT_STUCK_IN_EXTRUDER]
gcode:
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
        M118 Filament stuck in extruder
        PAUSE_MMU
    {% else %}
        M118 Filament not in extruder
    {% endif %}

# Call PAUSE_MMU if the filament is detected by the PINDA
[gcode_macro IS_FILAMENT_STUCK_IN_PINDA]
gcode:
     QUERY_ENDSTOPS
     IS_STUCK_IN_PINDA

[gcode_macro IS_STUCK_IN_PINDA]
gcode:
    {% if printer.query_endstops.last_query["manual_stepper gear_stepper"] == 1 %}
        M118 Filament stuck in PINDA
        PAUSE_MMU
    {% else %}
        M118 Filament not in PINDA
    {% endif %}

# Call PAUSE_MMU if the filament is detected by the splitter IR sensor
[gcode_macro IS_FILAMENT_STUCK_IN_SPLITTER]
gcode:
    {% if printer["filament_switch_sensor splitter_sensor"].filament_detected == True %}
        M118 Filament stuck in splitter
        PAUSE_MMU
    {% else %}
        M118 Filament not in splitter
    {% endif %}

############################################
#
# M702 macro called by the end-gcode to eject the filament at the end of the print
#
############################################

# Eject the filament with ramming from the extruder nozzle to the MMU2S
[gcode_macro EJECT_RAMMING]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["gcode_macro SELECT_TOOL"].color_selected|int != -1 %}
    M118 UT {printer["gcode_macro SELECT_TOOL"].color_selected|int} ...
    UNLOAD_FILAMENT_IN_EXTRUDER_WITH_RAMMING
    SELECT_TOOL VALUE={printer["gcode_macro SELECT_TOOL"].color_selected|int}
    UNLOAD_FILAMENT_FROM_EXTRUDER
    {% endif %}
    {% endif %}

# M702 first part
# unload filament if inserted into the IR sensor
[gcode_macro M702]
gcode:
    G91
    G1 Z{printer["gcode_macro VAR_MMU2S"].pause_z}
    G90
    G1 X{printer["gcode_macro VAR_MMU2S"].pause_x} Y{printer["gcode_macro VAR_MMU2S"].pause_y} F3000
    UT
    QUERY_ENDSTOPS
    END_M702

# M702 second part
# Unselect the current tool
[gcode_macro END_M702]
gcode:
    {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
    {% if printer.query_endstops.last_query["manual_stepper gear_stepper"] != 1 %}
        UNSELECT_TOOL
        M118 M702 ok ...
    {% else %}
        M118 M702 Error !!!
    {% endif %}
    {% else %}
    UNSELECT_TOOL
    SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE=-1
    M118 M702 ok ...
    {% endif %}

############################################
#
# MACROS called during homing to try to eject the filament if loaded
#
############################################

# Preheat the heater if needed and unload the filament with ramming
# eject from nozlle to extruder gear out
[gcode_macro EJECT_FROM_EXTRUDER]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
        M118 Filament in extruder, trying to eject it ..
        M118 Preheat Nozzle
        M109 S{printer["gcode_macro VAR_MMU2S"].extruder_eject_temp}
        UNLOAD_FILAMENT_IN_EXTRUDER_WITH_RAMMING
        M104 S0
    {% else %}
        M118 Filament not in extruder
    {% endif %}
    {% endif %}

# Eject from extruder gear to MMU2S
[gcode_macro EJECT_BEFORE_HOME]
gcode:
    M118 Eject Filament if loaded ...
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == True %}
        EJECT_FROM_EXTRUDER
        IS_FILAMENT_STUCK_IN_EXTRUDER
    {% endif %}
    {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
    {% if printer.query_endstops.last_query["manual_stepper gear_stepper"] == 1 %}
        UNLOAD_FILAMENT_FROM_EXTRUDER
        IS_FILAMENT_STUCK_IN_PINDA
        M118 Filament ejected !
    {% else %}
        M118 Filament already ejected !
    {% endif %}
    {% else %}
        M118 Filament already ejected !
    {% endif %}

############################################
#
# Homing MACROS
# HOME_MMU must be called before using the MMU2S
#
############################################

# Home MMU if not homed
[gcode_macro HOME_MMU]
variable_home: -1
gcode:
    {% if printer["gcode_macro HOME_MMU"].home == -1 %}
        FORCE_HOME_MMU
    {% else %}
        M118 MMU already homed !
        MMU_UNLOCK
    {% endif %}

# Home the MMU
# eject filament if loaded with EJECT_BEFORE_HOME
# next home the mmu with HOME_MMU_ONLY
[gcode_macro FORCE_HOME_MMU]
gcode:
    SET_FILAMENT_SENSOR SENSOR=ir_sensor ENABLE=0
    {% if printer["gcode_macro VAR_MMU2S"].splitter_endstop == 1 %}
    SET_FILAMENT_SENSOR SENSOR=splitter_sensor ENABLE=0
    {% endif %}
    SET_GCODE_VARIABLE MACRO=HOME_MMU VARIABLE=home VALUE=1
    M118 Homing MMU ...
    QUERY_ENDSTOPS
    EJECT_BEFORE_HOME
    HOME_MMU_ONLY

# Home the idler
[gcode_macro HOME_IDLER]
gcode:
    M118 Homing idler
    MANUAL_STEPPER STEPPER=idler_stepper SET_POSITION=0
    MANUAL_STEPPER STEPPER=idler_stepper MOVE=7
    {% if printer["gcode_macro VAR_MMU2S"].tmc2209_sensorless ==  0 %}
    MANUAL_STEPPER STEPPER=idler_stepper MOVE=-95
    {% else %}
    G4 P2000
    MANUAL_STEPPER STEPPER=idler_stepper MOVE=-95 STOP_ON_ENDSTOP=1
    {% endif %}
    MANUAL_STEPPER STEPPER=idler_stepper SET_POSITION=2
    MANUAL_STEPPER STEPPER=idler_stepper MOVE={printer["gcode_macro VAR_MMU2S"].idler_home_position}

# Home selector
[gcode_macro HOME_SELECTOR]
gcode:
    M118 Homing selector
    MANUAL_STEPPER STEPPER=selector_stepper SET_POSITION=0
    {% if printer["gcode_macro VAR_MMU2S"].tmc2209_sensorless ==  0 %}
    MANUAL_STEPPER STEPPER=selector_stepper MOVE=-76
    {% else %}
    G4 P2000
    MANUAL_STEPPER STEPPER=selector_stepper MOVE=-76 STOP_ON_ENDSTOP=1
    {% endif %}
    MANUAL_STEPPER STEPPER=selector_stepper SET_POSITION=0

# Home the MMU :
# 1) home the idler
# 2) home the color selector (if needed)
# 3) try to load filament 0 to PINDA and then unload it. Used to verify the MMU2S gear
#
# if all is ok, the MMU2S is ready to be used
[gcode_macro HOME_MMU_ONLY]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    HOME_IDLER
    {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
    HOME_SELECTOR
    {% endif %}
    MANUAL_STEPPER STEPPER=idler_stepper MOVE=0
    SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=tool_selected VALUE=-1
    SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE=-1
    M118 Test idler filament 0
    SELECT_TOOL VALUE=0
    {% if printer["gcode_macro VAR_MMU2S"].enable_5in1 == 0 %}
    M118 Test load filament 0
    LOAD_FILAMENT_TO_PINDA
    G4 P1000
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=-10
    UNLOAD_FILAMENT_FROM_PINDA
    {% else %}
    SET_GCODE_VARIABLE MACRO=SELECT_TOOL VARIABLE=color_selected VALUE=-1
    {% endif %}
    UNSELECT_TOOL
    SET_GCODE_VARIABLE MACRO=HOME_MMU VARIABLE=home VALUE=1
    M400
    M118 Homing MMU ended ...
    {% else %}
    M118 Homing MMU failed, MMU is paused, unlock it ...
    {% endif %}

###############################################
###############################################

###############################################
#
# TEST ROUTINES
#
###############################################
[gcode_macro MMU_TEST_LOAD]
gcode:
    G28
    HOME_MMU
    G1 X100 Y-20 F2000
    {% for i in range(11) %}
    M118 Test {i}
    {% for j in range(5) %}
    SELECT_TOOL VALUE={j}
    LOAD_FILAMENT_TO_EXTRUDER
    G4 P1000
    SELECT_TOOL VALUE={j}
    UNLOAD_FILAMENT_FROM_EXTRUDER
    {% endfor %}
    {% endfor %}

[gcode_macro RETRY_LOAD_FILAMENT_IN_EXTRUDER_TEST]
gcode:
    {% if printer["filament_switch_sensor ir_sensor"].filament_detected == False %}
    M118 Retry loading ....
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
        M118 Loading Filament...
        MMU_ERROR_INCREMENT_LOAD
        G91
        SELECT_TOOL VALUE={printer["gcode_macro SELECT_TOOL"].color_selected|int}
        MANUAL_STEPPER STEPPER=gear_stepper MOVE=10 SPEED=10 SET_POSITION=0 SYNC=0
	G1 E10 F600
	MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
        MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
        G1 E10 F600
        UNSELECT_TOOL
        G1 E10 F1800
        G92 E0
        G90
        G4 P1000
    {% endif %}
    {% endif %}

[gcode_macro ONE_LOAD_UNLOAD]
gcode:
    {% if printer["gcode_macro PAUSE_MMU"].is_paused|int == 0 %}
    G91
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=20 SPEED=10 SET_POSITION=0 SYNC=0
    G1 E20 F600
    MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
    MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
    UNSELECT_TOOL
    G1 E22 F1393
    G92 E0
    G90
    G4 P1000
    RETRY_LOAD_FILAMENT_IN_EXTRUDER_TEST
    RETRY_LOAD_FILAMENT_IN_EXTRUDER_TEST
    RETRY_LOAD_FILAMENT_IN_EXTRUDER_TEST
    IS_FILAMENT_IN_EXTRUDER
    G91
    SELECT_TOOL VALUE={printer["gcode_macro SELECT_TOOL"].color_selected|int}
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=-40 SPEED=10 SET_POSITION=0 SYNC=0
    G1 E-40 F600
    MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
    MANUAL_STEPPER STEPPER=gear_stepper MOVE=-60 SPEED=50 SET_POSITION=0 SYNC=0
    G1 E-60 F3000
    MANUAL_STEPPER STEPPER=gear_stepper SYNC=1
    MANUAL_STEPPER STEPPER=gear_stepper SET_POSITION=0
    UNSELECT_TOOL
    G90
    G92 E0
    G4 P1000
    IS_FILAMENT_STUCK_IN_EXTRUDER
    {% endif %}

[gcode_macro MMU_TEST_LOAD_EXTRUDER]
gcode:
    G28
    HOME_MMU
    G1 X100 Y-20 F2000
    {% for i in range(11) %}
    M118 Test {i}
    {% for j in range(5) %}
    SELECT_TOOL VALUE={j}
    LOAD_FILAMENT_TO_EXTRUDER
    ONE_LOAD_UNLOAD
    SELECT_TOOL VALUE={j}
    UNLOAD_FILAMENT_FROM_EXTRUDER
    {% endfor %}
    {% endfor %}




###############################################
